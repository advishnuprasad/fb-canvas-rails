<!DOCTYPE html>
<html>
<head>
  <title>FBCanvasRails</title>
  <%= stylesheet_link_tag    "application", :media => "all" %>
  <%= javascript_include_tag "application" %>
  <script src="http://connect.facebook.net/en_US/all.js"></script> 
  <%= csrf_meta_tags %>

  <script type="text/javascript">
    FB.init({
      appId  : "<%= ENV['FB_APP_ID_TEST']%>",
      status : true, 
      cookie : true, 
      xfbml  : true  
    });
    $(document).ready(function(){

      FB.getLoginStatus(function(response) {
        console.log(response)
            if (response.status == 'connected') {
                var user_id = response.authResponse.userID;
                var page_id = "330123823834776"; //coca cola
                // var the_query = FB.Data.query(fql_query);

                FB.api('/me/likes/330123823834776', function(response) {
                // the_query.wait(function(rows) {

                    console.log(response.data);
                    if(response.data.length){
                      //the user already likes your page 
                      alert("Liked");
                    }
                    else{
                      //the user doesn'y like your page, or the user hasn't granted permission for you to access his likes. show him the like button
                      alert("Not Liked");
                      }
                });
            } else {
                alert("Not Logged in");
            }
        });
    });
    // If our app is not loaded in a canvas, refresh and load inside a canvas
    // if (window == window.top) {
    //   window.top.location = "<%= facebook_iframed_url %>";
    // }

    // // This is where we store the session data
    // window.Application = {};
    // window.Application.meta = <%= raw page_metadata.to_json %>;
  </script>
</head>
<body>

  <h1>Welcome!</h1>
  <h2>Main window loaded at <%= Time.now.to_s %>.</h2>
  <p>Don't forget to try clicking the links in Internet Explorer <= 9. A full reload of the Facebook IFrame will occur for each page. In smart browsers, PushState is used instead.</p>
  <p>Also, visit a few pages and try the back button, it should work as expected in any browser.</p>

  <% unless logged_in? %>
    <p><a href="/auth/facebook">LOGIN WITH FACEBOOK</a></p>
  <% end %>

  <div class="container">
    <div class="sidebar">
      <a href="/page1" class="cjax">Page 1</a>
      <br/>
      <a href="/page2" class="cjax">Page 2</a>
      <br/>
      <a href="/page3" class="cjax">Page 3</a>
    </div>

    <div class="main">
      <%= yield %>
    </div>
  </div>

  <div class="info">
    <p>
      request.env['facebook.params']:
      <textarea class='fb_params'><%= request.env['facebook.params'].to_yaml %></textarea>
    </p>
    <p>
      request.env['facebook.signed_request']:
      <textarea class='fb_params'><%= request.env['facebook.signed_request'].to_yaml %></textarea>
      Request
    </p>
  </div>

  <script type="text/javascript">
    // Enable CJAX browsing (ie: PushState on smart browsers, full top redirects for IE.)
    initCJAX(window);
  </script>
</body>
</html>